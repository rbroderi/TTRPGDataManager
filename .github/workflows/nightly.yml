name: Nightly Binaries

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            python: "3.13"
            artifact_name: TTRPGDataManager-linux
            output_name: TTRPGDataManager
            folder_name: TTRPGDataManager
          - os: windows-latest
            python: "3.13"
            artifact_name: TTRPGDataManager-windows
            output_name: TTRPGDataManager.exe
            folder_name: TTRPGDataManager

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-tk tk-dev tcl-dev

      - name: Install build dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $pkg = 'Microsoft.VisualStudio.2022.BuildTools'
          $args = '--passive --norestart --add Microsoft.VisualStudio.Workload.VCTools --includeRecommended'
          Write-Host 'Ensuring Visual Studio Build Tools with MSVC v143 components are installed...'
          winget install --id $pkg --source winget --override $args --force --accept-package-agreements --accept-source-agreements

      - name: Install uv
        run: |
          python -m pip install --upgrade pip
          pip install uv

      - name: Sync dependencies
        run: uv sync

      - name: Install Nuitka
        run: uv pip install nuitka

      - name: Build binary (Linux)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          mkdir -p cache bin artifacts
          CHAFA_DIR=$(uv run python -c "import chafa, pathlib; print(pathlib.Path(chafa.__file__).parent)")
          PYGMENTS_DIR=$(uv run python -c "import pygments, pathlib; print(pathlib.Path(pygments.__file__).parent)")
          uv run python -m nuitka \
            --standalone \
            --enable-plugin=tk-inter \
            --include-data-dir="$CHAFA_DIR"=chafa \
            --include-data-dir="$PYGMENTS_DIR"=pygments \
            --include-package=chafa \
            --include-package-data=chafa \
            --include-package=pygments \
            --include-package-data=pygments \
            --include-data-dir=data/img=data/img \
            --include-data-files=data/config.toml=data/config.toml \
            --include-data-files=data/settings.toml=data/settings.toml \
            --include-data-files=data/sun_valleyish.json=data/sun_valleyish.json \
            --include-data-files=data/db.ddl=data/db.ddl \
            --include-data-files=data/sample_encounters.yaml=data/sample_encounters.yaml \
            --include-data-files=data/sample_locations.yaml=data/sample_locations.yaml \
            --include-data-files=data/sample_npc.yaml=data/sample_npc.yaml \
            --include-data-dir=docs=docs \
            --output-dir=cache \
            --output-filename=${{ matrix.output_name }} \
            src/ttrpgdataman/main.py
          dist_dir=$(find cache -maxdepth 1 -type d -name '*.dist' | head -n 1)
          if [ -z "$dist_dir" ]; then echo 'Nuitka dist directory not found'; exit 1; fi
          rm -rf bin/${{ matrix.folder_name }}
          cp -r "$dist_dir" "bin/${{ matrix.folder_name }}"
          rm -rf artifacts/${{ matrix.artifact_name }}
          cp -r bin/${{ matrix.folder_name }} artifacts/${{ matrix.artifact_name }}

      - name: Build binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force cache | Out-Null
          New-Item -ItemType Directory -Force bin | Out-Null
          New-Item -ItemType Directory -Force artifacts | Out-Null
          $chafaDir = uv run python -c "import chafa, pathlib; print(pathlib.Path(chafa.__file__).parent)"
          $chafaDir = $chafaDir.Trim()
          $pygmentsDir = uv run python -c "import pygments, pathlib; print(pathlib.Path(pygments.__file__).parent)"
          $pygmentsDir = $pygmentsDir.Trim()
          uv run python -m nuitka `
            --standalone `
            --enable-plugin=tk-inter `
            --include-data-dir="$chafaDir"=chafa `
            --include-data-dir="$pygmentsDir"=pygments `
            --include-package-data=chafa `
            --include-package=pygments `
            --include-package-data=pygments `
            --include-data-dir=data/img=data/img `
            --include-data-files=data/config.toml=data/config.toml `
            --include-data-files=data/settings.toml=data/settings.toml `
            --include-data-files=data/sun_valleyish.json=data/sun_valleyish.json `
            --include-data-files=data/db.ddl=data/db.ddl `
            --include-data-files=data/sample_encounters.yaml=data/sample_encounters.yaml `
            --include-data-files=data/sample_locations.yaml=data/sample_locations.yaml `
            --include-data-files=data/sample_npc.yaml=data/sample_npc.yaml `
            --include-data-dir=docs=docs `
            --msvc=latest `
            --output-dir=cache `
            --output-filename=${{ matrix.output_name }} `
            src/ttrpgdataman/main.py
          $distDir = Get-ChildItem -Path cache -Directory -Filter '*.dist' | Select-Object -ExpandProperty FullName -First 1
          if (-not $distDir) { throw 'Nuitka dist directory not found.' }
          $binDir = Join-Path 'bin' '${{ matrix.folder_name }}'
          if (Test-Path $binDir) { Remove-Item -Recurse -Force $binDir }
          Copy-Item -Recurse -Force $distDir $binDir
          $artifactDir = Join-Path 'artifacts' '${{ matrix.artifact_name }}'
          if (Test-Path $artifactDir) { Remove-Item -Recurse -Force $artifactDir }
          Copy-Item -Recurse -Force $binDir $artifactDir

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: artifacts/${{ matrix.artifact_name }}

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Publish nightly release
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          automatic_release_tag: nightly
          prerelease: true
          title: Nightly Build ${{ github.run_number }}
          files: |
            dist/**/*
